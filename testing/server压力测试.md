##云平台压力测试

###测试方案
选用两种不同的测试方案，一是直接在服务器上模拟客户端，对服务器进行压力测试，此种压力测试执行简单，能很快得到结果，也基本上能反映出server的并发处理能力，一般webserver均采用此种方案，典型的方式如ab测试。第二种是写客户端脚本，模拟真实的设备，用多台电脑，每台电脑模拟500-2000台客户端对服务器进行并发压力测试，此种测试，效果更加逼真，与实际场景吻合度更高，得出的结论更加符合真实情况。

### 一、服务器上压测
在服务器上写测试脚本，模拟客户端，对服务器进行连接，并发送数据包，接收数据包，完成完整的数据收发流程，开100个线程，访问10000次请求，查看访问处理的时间，qps，从而得到服务器对并发的处理能力。

#### 1、裸压测
为了定性的看到最关键的处理指标，即socket收发处理能力，在server业务处理逻辑上，把业务处理去除，仅作简单的回复，结论如下：
	concurrency 500
	request num 500000
	lost num	0
	success num 500000
	total time	30.06
	req per second  16628
	one req use(ms)  0.06

#### 2、加上框架，字符串处理，逻辑判断

	concurrency 100
	request num 50000
	lost num	0
	success num 50000
	total time	4.232
	req per second  11814
	one req use(ms)  0.084

#### 3、加上redis数据更新
	
	concurrency 100
	request num 50000
	lost num	0
	success num 50000
	total time	7.644
	req per second  6540
	one req use(ms)  0.152

#### 4、加上mqtt消息推送
	
	concurrency 100
	request num 50000
	lost num	0
	success num 50000
	total time	24.66
	req per second  2027
	one req use(ms)  0.493

到第四这个地方，已经基本上是完整的流程了，这里没有考虑app端的访问，因为app端的访问并发不会很高，主要是mqtt会进行推送，这个也要看app开启使用服务的情况，实际情况qps还会偏低一些。

还有没有考虑的因素，是日志输出服务，管理后台服务，这些也都会占用一定的资源。


#### 5、结论

初步估算，qps大概能处理到 1500/s，以合众净化器为例，开机时上报大约5s一次，关机时大概15s一次，综合估算10s一次的话，可以同时服务15000台设备，要继续增加服务能力有以下几种办法：

- 增加服务器配置：目前是vps 2核，4G内存，最高可以升级到16核心，这样服务能力可以上升大约5倍
- 将服务分开：实际运行到一定阶段，为了提供更加稳定高效的服务，将服务分开部署是必须的，比如将mqtt分开部署，大概服务能力还可以上升150%，将redis服务，web服务分开，还可以上升300%。
- 当然还可以采用负载均衡的方式，直接加设备上去，这样理论上说，可以服务无限设备，当然，系统构架需要更加健壮，以便于维护。

如此算来，一个基本的成型的分布构架，即将部分服务分开的方式进行部署，大概可以支撑3-5万并发，也即30万台设备运行。


### 二、客户端仿真模拟
客户端模拟的情况尚未调的非常好，因此还需要再测试。

### 三、并发连接数

在服务器上，发起5万的并发连接，大概消耗300m内存，不耗费cpu资源，按照epoll模型的描述，每建立一个socket连接，实际上只是在server上占用8k左右的内存而已，因此没有上限，因此，目前的服务器保持10万连接是毫无问题的。