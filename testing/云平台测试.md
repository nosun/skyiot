#云平台测试
	author： nosun
	date  ： 2015-06-11

## 说明

本测试围绕着物联网云平台所提供的服务进行测试，其中包括TCP连接服务，Mqtt推送服务，客户端接口服务，管理后台的管理服务。

测试的目的，是为了验证服务的正确性、稳定性，以及了解其在一定压力下提供服务的能力。

## 功能性测试

功能性测试将依照T口协议，S口协议分别进行测试。

### T口协议

T口协议的测试，可以可以有两种方式，一种是通过TCP工具，第二种是自己撰写测试脚本，实现协议，目前先用第一种方式做说明。

#### 1. 设备注册/登录

- 设备注册与设备登录

设备端与服务器端建立tcp连接，并发送"login" 指定格式的 json 字符串，服务器查询Mysql数据库是否有该Mac地址存在，如果有，执行登录命令，插入一条登录日志，并令设备上线。否则，插入Mysql数据库一条新的设备，并令设备上线。

指令格式：

    {"sn":551,"cmd":"login","mac":"ACCF232C7D39","pv":"1.0","hfver":"1.0|1.0","data":["vid::2","pid::AP500","pkeyid::7427f","userve::V5105"]}

测试方法：  
使用tcp工具，连接服务器，并发送此字符串，查看服务器端数据库中的变化。

    + yun_device 设备表
    + yun_device_log——login 设备登录日志 

- 临时重定向
设备登录动作发生时，服务器端会查询设备的pid，并查询服务的Server，以及Mac是否在测试设备清单中，如果是会将设备导向指定的服务器。此时TCP服务器会给设备回复一条指令，并关闭当前连接。

正常情况下回复：
    
    {"sn":551,"cmd":"login","ret":200,"akey":"aaa","heart":60}
    
重定向情况下回复：

    {"sn":551,"cmd":"login","ret":200,"akey":"aaa","heart":60,"serverip":"ip:port"}
    
- 永久重定向
目前wifi模块尚未支持，略。

- 设备验证
验证设备发来的字符串是否合乎协议规范，对不符合的字符串，直接断开连接。
    + 设备端发来的字符串非json格式
    + 设备端发来的字符串经过解析，不符合协议具体的内容，比如指令格式不对
    + 设备端发来的字符串经过解析，具体的型号或者加密字符串不符合云平台的设定


#### 2. 设备状态查询

服务器端发送指令：

    {
        "sn": 1021,
        "cmd": "info",
    }

设备收到指令后回复收到，并异步上报设备状态：

    {
        "sn": 1021,
        "cmd": "info",
        "ret": 200
    }
    
#### 3. 发送心跳
设备端向服务器端发起心跳，服务器端收到心跳后回复心跳包，回复过程中可以主动改变心跳的值，从而控制设备端上报心跳的频率。

{"sn":111,"cmd":"heartbeat","mac":"ACCF232C7D39"}

#### 4. 设备控制

对TCP服务器端来说，反向控制设备也同样是通过一个 client 来进行的，可以是TCP，也可以是UDP（如果是UDP，服务器端需要监听UDP端口），client向服务器端发送指定的字符串，服务器端收到字符串会进行解析，从而向指定的设备发送指令。

例子：

    {"cmd":"command","mac":"ACCF232C7D39","data":{"sn":8660,"cmd":"download","data":["pw::1"]}}
    
控制指令这里是一个抽象的含义，可以是具体的命令，也可以是符合wifi模块协议的其他的指令，比如改变heartbeat值，比如info 查询，比如update升级。

#### 5. 上传状态
设备端上报状态，服务器端收到后给相应回复。

    {"sn":12698,"cmd":"upload","mac":"ACCF234DAEE4","data":["pw::1","lc::0","uv::0","io::0","mo::0","fa::1","tm::000","fi::59626","pm::0482","th::2641"]}

回复：

    {"sn":12698,"cmd": "upload","ret": 200}

#### 6. 上传限制
服务器端尚未实现，略

#### 7. WiFi固件升级
通过服务器端升级wifi固件，可以使用设备控制的方式，发送给已经连接到服务器端的设备。

    {"sn":1022,"cmd":"updatewifi","url":"http://182.92.148.183/download/firmwire/LPBS2W_v1.0.5.bin"}
    
设备端收到此指令之后，会给服务器端回复

    {"sn":1022,"cmd":"updatewifi","ret":"200"}
    
设备端升级完成之后，会上报升级结果

    {"sn":1022,"cmd":"updatewifi","ret":"201"} 成功
    {"sn":1022,"cmd":"updatewifi","ret":"401"} 失败

#### 8. 错误事件
wifi模块上报错误时间，服务器需要处理并记录，目前尚未完整考虑此事，略。

#### 9. 设备离线
设备端主动断开，设备状态从在线置为离线。
设备端超过指定时间（目前设置为90s）没有发任何消息，服务器端主动断开连接，设备状态从在线置为离线。

### S口协议

S口为服务器对App提供服务的接口，可以通过Postman 或者类似的工具进行接口测试，略。


## 稳定性测试
稳定性的问题，之前遇到过两个问题：  
+ 设备异常掉线：经过排查，发现是两个TCP同时跑的时候会相互干扰，后来处理后很少再发生这类问题。
+ 设备无法插入：本质上是Tcp Server 与 Mysql 保持的连接超时导致，此问题目前已经在测试机上解决，有待于进一步测试。

## 压力测试

压力测试：需要采用java Client的方式进行。



#PostMan Test C1

### 





