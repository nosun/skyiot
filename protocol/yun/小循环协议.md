#小循环协议
-----
###小循环设计原则与目标
+ **辅助大循环**：小循环作为大循环的辅助，主要为了提高大循环的用户体验，一般情况下不作为独立使用
+ **快速高效**：收状态发指令更加快捷，提高用户体验
+ **降低云端负载**：如果手机检测到设备在内网，则发指令优先走小循环而不经过云端转发，降低云端负载
+ **迅速感知设备状态改变**：设备状态改变会通过小循环迅速到达APP端并显示在UI，尤其是设备异常与报警，会比大循环推送更加迅速感知到
+ **双路降低丢包率**：如果手机与设备同在内网，且内网可连通外网，则通过双路控制设备和监听状态，降低丢包率

###小循环通信协议层概述

#####1）发现设备——UDP广播
与设备通信的前提是知道设备在内网的IP，由于设备在内网的IP由路由动态分配，所以无法预先知道。只能采用在局域网内UDP广播的方式进行设备发现。只要按照协议发送广播，WiFi模块端就会立即回复

#####2）与设备通信——TCP连接

小循环协议采用TCP短连接与长连接混合的通信方式，设备控制、上传状态、协议格式与大循环相同。

当前方案中，WiFi模块作为TCP Server，手机Apps作为TCP Client

常态情况使用TCP短连接，即Apps与WiFi模块建立TCP连接，发送请求包，收到应答包，及相应的回报协议后，断开连接

若Apps希望实时监控设备状态，则建立TCP连接后，只需按照指定频率发送心跳包维持连接不被WiFi模块收回，即可实时收到设备的上传状态协议包，退出实时监控状态时断开TCP连接

TCP长短连接的切换时机可根据APP UI界面的切换作为依据。当用户进入“监控界面”时，保持长连接。一旦离开监控界面，即断开长连接或切换短连接（停止心跳）

用户主控（MCU）的所有数据都将同时发送到服务器和本地，手机Apps可以使用最先收到的数据包(两条通道的sn号相同，便于判断不同通道的相同数据包，避免误决策)

### 1.广播发现（UDP）

向`48899`端口发送 `HF-A11ASSISTHREAD` 口令的UDP广播，模块会返回当前 IP 地址及MAC 地址信息，如`HF-A11ASSISTHREAD192.168.1.11,ACCF231120C4`

### 2.发送心跳
#### Request (Apps to WiFi):

	{
	    "sn": 1024,
	    "cmd": "heartbeat"
	}

#### Response (WiFi to Apps):

	{
	    "sn": 1024,
	    "cmd": "heartbeat",
	}

> 1、此包只为在长连接时维持连接，无应答包，WiFi模块会对10s内无数据的连接进行回收，故Apps的心跳周期应小于此值

> 2、每条JSON包应以\n作为结尾，以便从流中解析成帧。此规则适用于后面所有JSON包

> 3、sn: (Serial Number)，协议序号，用于超时重传机制的标识，识别请求和应答对。后面会在 `超时重传机制` 一章详细介绍

> 4、WiFi模块TCP Server的监听端口为 `8899` 

### 3.设备控制
#### Request (Apps to WiFi):
	{
	    "sn": 1025,
	    "cmd": "download",
	    ["data"]: "[
	        "switch::on",
	        "windspeed::high"
	    ]"
	}

> 1、 \[xxx] —— 被'['，']'包围的**JSON键**为传输中非必需包含项。而后面的 `"["switch::on",...]"` 则是由MCU透传出来的**Json String值**，目前是采用 `US-ASCII编码` ，未来根据厂家需求可能会是二进制的协议流（字节数较字符编码短，传输效率高），短期内不考虑。
 
> 2、此处WiFi模块中限制 `"data"` 列表项目数上限30个

> 3、若发送无 `"data"` 字段的 `设备控制` 包，则上传设备此时的全部状态，通过后面的 `上传状态` 命令


#### Response (WiFi to Apps):
	{
	    "sn": 1025,
	    "cmd": "download",
	    "ret": 200
	}

### 4.上传状态
#### Request (WiFi to Apps):

	{
	    "sn": 1026,
	    "cmd": "upload",
	    "mac": "AABBCCDDEEFF",
	    "data": [
	        "switch::on",
	        "windspeed::high"
	    ]
	}

> PS: 此处 `"data"` 则为必须项
> 
> `"data"` 对应Json Value的是具体业务数据，暂定交与APP UI层处理

#### Request (Apps to WiFi):

	{
	    "sn": 1026,
	    "cmd": "upload",
	    "ret": 200
	}

### 5.错误事件
#### Request (Apps to WiFi):

	{
	    "sn": 1027,
	    "cmd": "error",
	    "mac": "AABBCCDDEEFF",
	    "ret": 404
	}
#### Request (Apps to WiFi):

	{
	    "sn": 1027,
	    "cmd": "error",
	    "ret": 200
	}

## 超时重传机制
发送 `Request` 协议包后，等待制定时间，若没有收到 `Response` 协议包则进行重传，其中 `sn` 号每次发送时 `+1` ，上限为65535，溢出后归零重新计数，相应的应答包中，`sn` 保持与请求包相同，用来识别请求应答对

重传时 `sn` 号不变

## ret返回数字解释

<table style="font-size:14px">
	<tr><th>ret值</td>
		<th>解释</td></tr>
	<tr><td>200</td>
		<td>成功收到协议包</td></tr>
	<tr><td>403</td>
		<td>设备未授权</td></tr>
	<tr><td>404</td>
		<td>未接收到主控的串口数据</td></tr>
	<tr><td>501</td>
		<td width=200>不支持此协议</td></tr>
	<tr><td>503</td>
		<td>WiFi模块负载重，请设备稍后再发议</td></tr>
</table>